# Практические кейсы использования Helm

## Базы данных и Stateful-приложения

### PostgreSQL
- **Тип развертывания**: StatefulSet
- **Причины**:
  - Требуется стабильные и уникальные имена подов
  - Необходимо сохранение данных между перезапусками
  - Важен порядок запуска и обновления (primary/replica)
  - Требуется стабильное сетевое имя для каждого пода
- **Особенности конфигурации**:
  - Использование PersistentVolumeClaim для каждого пода
  - Настройка бэкапов через init-контейнеры
  - Конфигурация репликации через ConfigMap
  - Использование Secrets для паролей и сертификатов

### Redis
- **Тип развертывания**: 
  - StatefulSet для persistent режима
  - Deployment для cache-only режима
- **Причины выбора**:
  - В режиме persistent требуется сохранение данных
  - В режиме cache можно использовать более простой Deployment
- **Особенности**:
  - Настройка кластера через init-контейнеры
  - Конфигурация sentinel для high availability

## Веб-приложения

### Frontend приложения
- **Тип развертывания**: Deployment
- **Причины**:
  - Stateless природа
  - Легкое горизонтальное масштабирование
  - Не требуется сохранение состояния
- **Особенности**:
  - Использование Ingress для маршрутизации
  - ConfigMap для конфигурации nginx
  - Настройка SSL через cert-manager

### Backend API
- **Тип развертывания**: Deployment
- **Причины**:
  - Stateless архитектура
  - Возможность быстрого масштабирования
- **Особенности**:
  - Настройка health checks
  - Конфигурация через ConfigMap и Secrets
  - Service для внутренней коммуникации

## Очереди сообщений

### RabbitMQ
- **Тип развертывания**: StatefulSet
- **Причины**:
  - Необходимость сохранения очередей
  - Кластерная архитектура требует стабильных имен
- **Особенности**:
  - Настройка кластера через init-контейнеры
  - Persistence для сохранения сообщений
  - Management UI через отдельный Service

### Kafka
- **Тип развертывания**: StatefulSet
- **Причины**:
  - Требуется сохранение данных
  - Важен порядок запуска брокеров
  - Необходимы стабильные сетевые идентификаторы
- **Особенности**:
  - Zookeeper также как StatefulSet
  - Настройка retention через ConfigMap
  - Мониторинг через Prometheus экспортер

## Мониторинг и логирование

### Prometheus
- **Тип развертывания**: StatefulSet
- **Причины**:
  - Необходимость сохранения исторических данных
  - Важна консистентность при масштабировании
- **Особенности**:
  - Настройка retention через ConfigMap
  - Интеграция с Alert Manager
  - Настройка ServiceMonitor CRD

### Elasticsearch
- **Тип развертывания**: StatefulSet
- **Причины**:
  - Требуется сохранение индексов
  - Кластерная архитектура с ролями нод
- **Особенности**:
  - Настройка heap через resources
  - Конфигурация через custom CRD
  - Отдельные StatefulSet для master/data нод

## Лучшие практики по выбору типа развертывания

### Когда использовать StatefulSet:
1. Приложению требуется стабильное хранилище
2. Важен порядок запуска и обновления подов
3. Необходимы стабильные сетевые идентификаторы
4. Приложение работает в кластерном режиме

### Когда использовать Deployment:
1. Приложение stateless
2. Не важен порядок запуска подов
3. Не требуется сохранение данных
4. Нужно быстрое автоматическое масштабирование

### Когда использовать DaemonSet:
1. Для системных сервисов на каждой ноде
2. Для сбора логов и метрик
3. Для сетевых плагинов
4. Для агентов мониторинга

## Особенности настройки Helm чартов

### Для StatefulSet приложений:
- Настройка volumeClaimTemplates
- Правильная конфигурация headless сервиса
- Настройка политики обновления
- Конфигурация init-контейнеров

### Для Deployment приложений:
- Настройка стратегии развертывания
- Конфигурация горизонтального автомасштабирования
- Настройка readiness/liveness проб
- Управление ресурсами

### Общие рекомендации:
1. Всегда указывайте ресурсные лимиты
2. Используйте подходящие probe-ы
3. Настраивайте политики безопасности
4. Правильно организуйте зависимости между чартами 

## Безопасность и соответствие требованиям

### Управление секретами
- **Внешние решения**:
  - HashiCorp Vault
  - AWS Secrets Manager
  - Azure Key Vault
- **Лучшие практики**:
  - Использование внешних провайдеров секретов
  - Ротация секретов через операторы
  - Шифрование секретов в git (SOPS, sealed-secrets)

### Network Policies
- **Типичные сценарии**:
  - Изоляция окружений
  - Ограничение доступа между сервисами
  - Защита баз данных
- **Рекомендации**:
  - Всегда определяйте явные политики
  - Используйте labels для группировки
  - Начинайте с deny-all политики

### Pod Security Policies
- **Ключевые настройки**:
  - Запрет привилегированных контейнеров
  - Ограничение возможностей (capabilities)
  - Запрет монтирования hostPath
- **Имплементация**:
  - Через OPA/Gatekeeper
  - Через встроенные механизмы K8s
  - Через специальные операторы

## Масштабирование и производительность

### Горизонтальное масштабирование
- **Для Stateless приложений**:
  - HorizontalPodAutoscaler по CPU/Memory
  - Custom метрики (очереди, latency)
  - Prometheus Adapter для custom метрик
- **Для Stateful приложений**:
  - Операторы для автоматического масштабирования
  - Учет репликации и синхронизации данных
  - Правильная настройка PDB (Pod Disruption Budget)

### Вертикальное масштабирование
- **Использование VPA**:
  - Автоматическая корректировка ресурсов
  - Режимы работы (Auto/Recommendation)
  - Исключение критических сервисов
- **Мониторинг и анализ**:
  - Grafana dashboards для ресурсов
  - Cost optimization через kubecost
  - Alerts на нехватку ресурсов

## Миграция и обновление

### Миграция данных
- **Стратегии**:
  - Blue-Green deployment
  - Canary releases
  - Rolling updates
- **Инструменты**:
  - Init контейнеры для миграций
  - Backup/Restore операторы
  - Velero для бэкапа кластера

### Обновление версий
- **План обновления**:
  - Тестирование на dev-среде
  - Резервное копирование
  - Проверка совместимости версий
- **Автоматизация**:
  - CI/CD пайплайны
  - ArgoCD для GitOps
  - Flux для автоматических обновлений

## Интеграция с внешними сервисами

### Cloud Provider интеграция
- **Storage**:
  - CSI драйверы для облачных дисков
  - Backup в облачные хранилища
  - Snapshot классы
- **Networking**:
  - Cloud Load Balancers
  - VPC интеграция
  - DNS интеграция

### Service Mesh
- **Istio**:
  - Настройка через IstioOperator
  - Мониторинг и трейсинг
  - Безопасность и mTLS
- **Linkerd**:
  - Легковесная альтернатива
  - Автоматическая инъекция прокси
  - Наблюдаемость

## Отладка и диагностика

### Логирование
- **Стеки**:
  - ELK (Elasticsearch, Logstash, Kibana)
  - Loki + Grafana
  - CloudWatch/StackDriver
- **Практики**:
  - Структурированные логи
  - Корреляция через trace ID
  - Ротация логов

### Трейсинг
- **Инструменты**:
  - Jaeger
  - Zipkin
  - OpenTelemetry
- **Интеграция**:
  - Автоматическая инструментация
  - Sampling стратегии
  - Визуализация в Grafana

### Профилирование
- **Методы**:
  - CPU/Memory профили
  - Сетевая активность
  - Дисковые операции
- **Инструменты**:
  - pprof
  - perf
  - eBPF 

## Конкретные пользовательские сценарии

### Микросервисная архитектура e-commerce платформы
- **Компоненты**:
  - Product Service (Deployment)
  - Cart Service (Deployment + Redis StatefulSet)
  - Order Service (Deployment + PostgreSQL StatefulSet)
  - Payment Service (Deployment)
  - Notification Service (Deployment + RabbitMQ StatefulSet)
- **Особенности реализации**:
  - Общий Ingress с path-based routing
  - Межсервисная коммуникация через Service Mesh
  - Распределенное кэширование
  - Асинхронная обработка заказов
- **Helm-специфика**:
  - Umbrella chart для всего приложения
  - Подчарты для каждого сервиса
  - Общие зависимости в requirements.yaml
  - Переиспользуемые helpers

### CI/CD платформа на базе GitLab
- **Компоненты**:
  - GitLab (StatefulSet)
  - GitLab Runner (Deployment)
  - MinIO (StatefulSet для артефактов)
  - Redis (StatefulSet)
  - PostgreSQL (StatefulSet)
- **Особенности реализации**:
  - Persistent storage для репозиториев
  - Автоматическое масштабирование runner'ов
  - Backup/restore процедуры
  - SSL-терминация
- **Helm-специфика**:
  - Кастомные values для разных окружений
  - Init-контейнеры для миграций
  - Интеграция с внешними секретами
  - Настройка RBAC

### Мониторинг-стек для production
- **Компоненты**:
  - Prometheus (StatefulSet)
  - Grafana (Deployment)
  - AlertManager (StatefulSet)
  - Node Exporter (DaemonSet)
  - Loki (StatefulSet)
  - Vector (DaemonSet)
- **Особенности реализации**:
  - Долгосрочное хранение метрик
  - Федерация Prometheus
  - Автоматическое обнаружение таргетов
  - High Availability setup
- **Helm-специфика**:
  - Разделение по namespace'ам
  - Настройка retention policies
  - Интеграция с внешними системами оповещения
  - Автоматическая генерация dashboard'ов

### Machine Learning платформа
- **Компоненты**:
  - Jupyter Hub (Deployment)
  - MLflow (Deployment + PostgreSQL)
  - Kubeflow Pipelines (множество компонентов)
  - MinIO (StatefulSet для артефактов)
  - GPU-операторы
- **Особенности реализации**:
  - Управление GPU-ресурсами
  - Persistent storage для notebook'ов
  - Версионирование моделей
  - Распределенные тренировки
- **Helm-специфика**:
  - Resource quotas для GPU
  - Интеграция с внешними хранилищами
  - Настройка аутентификации
  - Управление зависимостями Python-пакетов

### Платформа для real-time аналитики
- **Компоненты**:
  - Kafka (StatefulSet)
  - ClickHouse (StatefulSet)
  - Debezium (Deployment)
  - Redpanda Console (Deployment)
  - Grafana (Deployment)
- **Особенности реализации**:
  - Стриминг данных в реальном времени
  - Репликация данных
  - Автоматическое масштабирование
  - Мониторинг задержек
- **Helm-специфика**:
  - Тонкая настройка Kafka
  - Управление схемами данных
  - Настройка retention
  - Backup стратегии

### Игровой бэкенд
- **Компоненты**:
  - Game Server (Deployment)
  - Matchmaking Service (Deployment)
  - Leaderboard (Redis StatefulSet)
  - User Profile (MongoDB StatefulSet)
  - WebSocket Gateway (Deployment)
- **Особенности реализации**:
  - Горизонтальное масштабирование игровых серверов
  - Сессионная персистентность
  - Реал-тайм коммуникация
  - Географическое распределение
- **Helm-специфика**:
  - Автоскейлинг по нагрузке
  - Настройка сетевой связности
  - Управление игровыми сессиями
  - Multi-region deployment

### IoT платформа
- **Компоненты**:
  - MQTT Broker (StatefulSet)
  - Time Series DB (StatefulSet)
  - Device Registry (Deployment + PostgreSQL)
  - Rules Engine (Deployment)
  - API Gateway (Deployment)
- **Особенности реализации**:
  - Обработка миллионов подключений
  - Хранение временных рядов
  - Управление устройствами
  - Edge computing
- **Helm-специфика**:
  - Настройка MQTT брокера
  - Управление сертификатами устройств
  - Масштабирование по числу подключений
  - Географическая репликация

### CMS платформа
- **Компоненты**:
  - Headless CMS (Deployment)
  - Media Storage (MinIO StatefulSet)
  - Search Engine (Elasticsearch StatefulSet)
  - Cache Layer (Redis StatefulSet)
  - CDN Integration
- **Особенности реализации**:
  - Управление медиа-контентом
  - Полнотекстовый поиск
  - Кэширование контента
  - Автоматическая оптимизация изображений
- **Helm-специфика**:
  - Интеграция с CDN
  - Настройка бэкапов
  - Управление индексами
  - Масштабирование по трафику

### Платформа для A/B тестирования
- **Компоненты**:
  - Experiment Service (Deployment)
  - Analytics Collector (Deployment)
  - Feature Flags Service (Deployment)
  - Results Storage (ClickHouse StatefulSet)
  - Dashboard (Deployment)
- **Особенности реализации**:
  - Распределение трафика
  - Сбор и анализ метрик
  - Статистическая обработка
  - Real-time отчетность
- **Helm-специфика**:
  - Конфигурация экспериментов
  - Настройка сбора данных
  - Управление feature flags
  - Интеграция с CI/CD

### Платформа для видеостриминга
- **Компоненты**:
  - Media Server (Deployment)
  - Transcoding Service (Deployment)
  - Content Delivery (Deployment)
  - User Management (Deployment)
  - Analytics (Deployment)
- **Особенности реализации**:
  - Обработка видеопотоков
  - Адаптивный битрейт
  - Географическое распределение
  - DRM интеграция
- **Helm-специфика**:
  - Настройка медиа-серверов
  - Управление транскодингом
  - CDN интеграция
  - Мониторинг качества 